name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    NODE_VERSION: "20"
    PNPM_VERSION: "10"

jobs:
    # Cache dependencies for faster builds
    setup:
        runs-on: ubuntu-latest
        outputs:
            cache-key: ${{ steps.cache-key.outputs.value }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Generate cache key
              id: cache-key
              run: echo "value=${{ github.sha }}-${{ hashFiles('**/pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

    # Security scanning
    security:
        needs: setup
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run security audit
              run: pnpm audit --audit-level moderate

    # Lint and format check
    lint:
        needs: setup
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run ESLint
              run: pnpm lint

            - name: Check Prettier formatting
              run: pnpm format:check

            - name: Check TypeScript types
              run: pnpm build:types

    # Build types package first (required by backend and frontend)
    build-types:
        needs: setup
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build types
              run: pnpm build:types

            - name: Upload types build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: types-build
                  path: packages/types/dist

    # Test all packages (backend needs types built first)
    test:
        needs: [setup, build-types]
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                package: [backend, frontend, types]
        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_USER: wingtechbot
                    POSTGRES_PASSWORD: wingtechbot_password
                    POSTGRES_DB: wingtechbot_test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup FFmpeg
              if: matrix.package == 'backend'
              uses: FedericoCarboni/setup-ffmpeg@v3
              with:
                  ffmpeg-version: release
                  github-token: ${{ github.server_url == 'https://github.com' && github.token || '' }}

            - name: Get pip cache dir
              if: matrix.package == 'backend'
              id: pip-cache
              run: echo "dir=$(pip3 cache dir)" >> $GITHUB_OUTPUT

            - name: Cache pip packages
              if: matrix.package == 'backend'
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ steps.pip-cache.outputs.dir }}
                      ~/.local/lib/python*/site-packages
                      ~/.local/bin
                  key: ${{ runner.os }}-pip-yt-dlp-${{ hashFiles('.github/workflows/ci.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-yt-dlp-

            - name: Install yt-dlp
              if: matrix.package == 'backend'
              run: pip3 install --user yt-dlp

            - name: Add yt-dlp to PATH
              if: matrix.package == 'backend'
              run: echo "$HOME/.local/bin" >> $GITHUB_PATH

            - name: Verify audio tools installation
              if: matrix.package == 'backend'
              run: |
                  ffmpeg -version
                  yt-dlp --version

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Download types build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: types-build
                  path: packages/types/dist

            - name: Run tests for ${{ matrix.package }}
              run: pnpm --filter ${{ matrix.package }} test${{ matrix.package == 'backend' && ':ci' || '' }}
              env:
                  DATABASE_URL: postgresql://wingtechbot:wingtechbot_password@localhost:5432/wingtechbot_test
                  NODE_ENV: CICD
                  CI: true
                  SKIP_CHANNEL_PROCESSING_ON_STARTUP: true

                  DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
                  DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
                  DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
                  DISCORD_BOT_CHANNEL_ID: ${{ secrets.DISCORD_BOT_CHANNEL_ID }}

                  TESTER_DISCORD_TOKEN: ${{ secrets.TESTER_DISCORD_TOKEN }}
                  TESTER_DISCORD_CLIENT_ID: ${{ secrets.TESTER_DISCORD_CLIENT_ID }}
                  TESTER_DISCORD_GUILD_ID: ${{ secrets.TESTER_DISCORD_GUILD_ID }}
                  TESTER_DISCORD_BOT_CHANNEL_ID: ${{ secrets.TESTER_DISCORD_BOT_CHANNEL_ID }}

                  LLM_API_KEY: ${{ secrets.LLM_API_KEY }}

            - name: Upload test coverage
              uses: codecov/codecov-action@v5
              if: matrix.package == 'backend'
              with:
                  file: ./packages/backend/coverage/lcov.info
                  flags: backend
                  name: backend-coverage

    # Build backend and frontend packages (needs types built first)
    build:
        needs: [setup, build-types]
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                package: [backend, frontend]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Download types build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: types-build
                  path: packages/types/dist

            - name: Build ${{ matrix.package }}
              run: pnpm build:${{ matrix.package }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.package }}-build
                  path: packages/${{ matrix.package }}/dist

    # Database migration check
    db-check:
        needs: setup
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: test_db
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Setup test environment
              run: |
                  echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_db" >> $GITHUB_ENV

            - name: Generate database types
              run: pnpm --filter backend db:generate

            - name: Check database migrations
              run: pnpm --filter backend db:push --accept-data-loss

    # Docker build test for backend
    docker-build:
        needs: setup
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build backend Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./packages/backend/Dockerfile
                  push: false
                  load: true
                  tags: wingtechbot-backend:test
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  target: production

            - name: Verify Docker image
              run: |
                  docker images wingtechbot-backend:test
                  docker inspect wingtechbot-backend:test
